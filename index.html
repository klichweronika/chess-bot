<!DOCTYPE html>
<html>
  <head>
    <title>Chess</title>
    <link rel="stylesheet" href="css/chessboard-1.0.0.min.css" />
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css"
      integrity="sha384-q94+BZtLrkL1/ohfjR8c6L+A6qzNH9R2hBLwyoAfu3i/WCvQjzL2RQJ3uNHDISdU"
      crossorigin="anonymous"
    />

    <script src="node_modules/chess.js/chess.js"></script>
    <script src="node_modules/@chrisoakman/chessboardjs/dist/chessboard-1.0.0.css"></script>
    <script src="node_modules/@chrisoakman/chessboardjs/dist/chessboard-1.0.0.js"></script>
    <script src="styles.css"></script>
  </head>
  <body>
    <div id="myBoard" style="width: 500px; margin: 0 auto"></div>
    <div class="gameInfo" style="text-align: center; font-size: 2rem">
      <label>Status:</label>
      <div id="status"></div>

      <label>FEN:</label>
      <div id="fen"></div>
      <label> PGN:</label>
      <div id="pgn"></div>
      <button id="resetButton">Reset game</button>
    </div>

    <script>
      var board = null;
      var game = new Chess();
      var $status = $("#status");
      var $fen = $("#fen");
      var $pgn = $("#pgn");
      var whiteSquareGrey = "#a9a9a9";
      var blackSquareGrey = "#696969";

      function removeGreySquares() {
        $("#myBoard .square-55d63").css("background", "");
      }

      function greySquare(square) {
        var $square = $("#myBoard .square-" + square);

        var background = whiteSquareGrey;
        if ($square.hasClass("black-3c85d")) {
          background = blackSquareGrey;
        }

        $square.css("background", background);
      }

      function onDragStart(source, piece, position, orientation) {
        if (game.game_over()) return false;
        if (
          (game.turn() === "w" && piece.search(/^b/) !== -1) ||
          (game.turn() === "b" && piece.search(/^w/) !== -1)
        ) {
          return false;
        }
      }

      function makeRandomMove() {
        var possibleMoves = game.moves();

        if (possibleMoves.length === 0) return;

        var randomIdx = Math.floor(Math.random() * possibleMoves.length);
        game.move(possibleMoves[randomIdx]);
        board.position(game.fen());
      }

      function onDrop(source, target) {
        var move = game.move({
          from: source,
          to: target,
          promotion: "q",
        });

        if (move === null) return "snapback";

        window.setTimeout(makeRandomMove, 250);
        updateStatus();
      }

      function onMouseoverSquare(square, piece) {
        var moves = game.moves({
          square: square,
          verbose: true,
        });

        if (moves.length === 0) return;

        greySquare(square);

        for (var i = 0; i < moves.length; i++) {
          greySquare(moves[i].to);
        }
      }

      function onMouseoutSquare(square, piece) {
        removeGreySquares();
      }

      function onSnapEnd() {
        board.position(game.fen());
      }

      function onSnapEnd() {
        board.position(game.fen());
      }

      function updateStatus() {
        var status = "";

        var moveColor = "White";
        if (game.turn() === "b") {
          moveColor = "Black";
        }

        if (game.in_checkmate()) {
          status = "Game over, " + moveColor + " is in checkmate.";
        } else if (game.in_draw()) {
          status = "Game over, drawn position";
        } else {
          status = moveColor + " to move";

          if (game.in_check()) {
            status += ", " + moveColor + " is in check";
          }
        }

        $status.html(status);
        $fen.html(game.fen());
        $pgn.html(game.pgn());
      }

      var config = {
        draggable: true,
        position: "start",
        onDragStart: onDragStart,
        onDrop: onDrop,
        onMouseoutSquare: onMouseoutSquare,
        onMouseoverSquare: onMouseoverSquare,
        onSnapEnd: onSnapEnd,
      };
      board = Chessboard("myBoard", config);

      $("#resetButton").on("click", board.start);
      $("#resetButton").on("click", status(""));
    </script>
  </body>
</html>
